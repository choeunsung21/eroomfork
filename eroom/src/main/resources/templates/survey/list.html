<!DOCTYPE html>
<html lang="en-US" dir="ltr" data-navigation-type="default" data-navbar-horizontal-shape="default" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/include/layout}">
<th:block layout:fragment="content">
	<style>
/* 삭제 버튼 css */
.item-wrapper {
	position: relative;
}

.item-wrapper input.form-control {
	padding-right: 2rem;
}

.item-wrapper .btn-close {
	position: absolute;
	top: 50%;
	right: 0.2rem;
	transform: translateY(-50%);
}
</style>
	<link href="vendors/choices/choices.min.css" rel="stylesheet" />
	<script src="vendors/choices/choices.min.js"></script>
	<main class="main" id="top">
		<div class="pb-8">
			<h2 class="mb-4">설문</h2>
			<div id="reports" data-list='{"valueNames":["title","text","priority","reportsby","reports","date"],"page":9,"pagination":true}'>
				<div class="row g-3 justify-content-between mb-2">
					<div class="col-12">
						<div class="d-md-flex justify-content-between">
							<div class="mb-3">
								<!-- 설문 생성 팝업창 -->
								<form th:action="@{/survey/create}" method="post" id="surveyForm">
									<div class="modal fade" id="create-survey" tabindex="-1" aria-labelledby="scrollingLongModalLabel2" aria-hidden="true">
										<div class="modal-dialog modal-dialog-scrollable">
											<div class="modal-content">
												<div class="modal-header">
													<h5 class="modal-title" id="scrollingLongModalLabel2">설문 등록</h5>
													<button class="btn btn-close p-1" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
												</div>
												<div class="modal-body">
													<!-- 설문 등록 모달 본문 -->
													<!-- <input class="form-control" id="surveyWriter" name="surveyWriter" type="hidden" th:value="${#authentication.principal.employee.employeeName}"> -->
													<div class="row mb-3">
														<label class="col-sm-2 col-form-label text-end" for="surveyTitle">제목</label>
														<div class="col-sm-8">
															<input class="form-control" id="surveyTitle" name="surveyTitle" type="text" style="width: 97.2%;">
														</div>
													</div>
													<!-- 항목 div -->
													<div class="row mb-3">
														<label class="col-sm-2 col-form-label text-end" for="inputItem">항목</label>
														<div class="col-sm-8">
															<div id="itemScrollBox" style="max-height: 400px; overflow-y: auto;">
																<div id="itemContainer1">
																	<input class="form-control mb-2" id="inputItem" name="items" type="text" style="width: 97.2%;">
																</div>
																<div id="itemContainer">
																	<input class="form-control mb-2" name="items" type="text" style="width: 97.2%;">
																</div>
															</div>
															<!-- 항목 추가 버튼 -->
															<div class="text-center mt-2">
																<button class="btn btn-phoenix-primary" type="button" id="addItemBtn">+ 항목 추가</button>
															</div>
														</div>
													</div>
													<div class="row mb-3">
														<div class="col-form-label col-sm-2 pt-0"></div>
														<div class="col-sm-8">
															<div class="form-check">
																<input class="form-check-input" id="gridCheck1" name="allowMultiple" type="checkbox"> <label class="form-check-label" for="gridCheck1">복수선택</label>
															</div>
															<div class="form-check">
																<input class="form-check-input" id="gridCheck2" name="anonymousVote" type="checkbox"> <label class="form-check-label" for="gridCheck2">익명투표</label>
															</div>
														</div>
													</div>
													<div class="row mb-3">
														<label class="col-sm-2 col-form-label text-end" for="basic-form-dob">참여자</label>
														<div class="col-8">
															<!-- 팀 선택 -->
															<div class="row mb-3">
																<div class="col-sm-8">
																	<div class="mb-3">
																		<select class="form-select" id="selectTeam" onchange="changeTeamSelection(this.value)" style="width: 97.2%;">
																			<option disabled selected>-- 팀 선택 --</option>
																			<option th:each="team : ${structureList}" th:value="${team.structure_no}" th:text="${team.code_name}"></option>
																		</select>
																	</div>
																	<!-- 선택된 팀 보여주기 -->
																	<div class="mb-3">
																		<label class="form-label" style="padding-left: 0;">선택된 팀</label>
																		<div id="selectedTeam">
																			<!-- 선택된 팀 정보가 배지로 표시됨 -->
																		</div>
																	</div>
																</div>
															</div>
														</div>
													</div>
													<div class="row mb-3">
														<label class="col-sm-2 col-form-label text-end" for="basic-form-dob">마감일</label>
														<div class="col-sm-8">
															<input class="form-control" id="basic-form-dob" name="deadline" type="datetime-local" style="width: 97.2%;">
														</div>
													</div>
												</div>
												<div class="modal-footer">
													<button class="btn btn-outline-primary" type="button" data-bs-dismiss="modal">취소</button>
													<button class="btn btn-primary" type="submit">등록</button>
												</div>
											</div>
										</div>
									</div>
								</form>
								<!-- 문서화 버튼? -->
								<!-- <button class="btn btn-link text-body px-0"><span class="fa-solid fa-file-export fs-9 me-2"></span>Export </button> -->
							</div>
						</div>
					</div>
				</div>
				<div class="row g-3 list" id="reportsList">
					<!-- 설문 상세 -->
					<th:block th:each="survey : ${surveyList}">
						<div class="col-12 col-xl-4">
							<div class="card h-100">
								<div class="card-body">
									<div class="border-bottom border-translucent">
										<div class="d-flex align-items-start mb-1">
											<div class="d-sm-flex align-items-center ps-2">
												<button class="btn btn-link me-1 mb-1 fs-6 p-0" th:attr="data-survey-id=${survey.surveyNo}" data-bs-toggle="modal" data-bs-target="#survey-detail" th:text="${survey.surveyTitle}">설문 제목</button>
												<div class="modal fade" id="survey-detail" tabindex="-1" aria-labelledby="scrollingLongModalLabel2" aria-hidden="true">
													<div class="modal-dialog modal-dialog-scrollable">
														<div class="modal-content">
															<div class="modal-header">
																<h5 class="modal-title" id="scrollingLongModalLabel2">투표</h5>
																<button class="btn btn-close p-1" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
															</div>
															<!-- 설문 항목 -->
															<div class="modal-body">
																<!-- <ul id="surveyItemList" class="list-group"></ul> -->
																<div id="surveyItemList" class="d-flex flex-column gap-2"></div>
															</div>
															<div class="modal-footer">
																<button class="btn btn-outline-primary" type="button" data-bs-dismiss="modal">취소</button>
																<button class="btn btn-primary" type="button" id="voteConfirmBtn">투표</button>
															</div>
														</div>
													</div>
												</div>
												<div class="d-flex align-items-center" th:if="${survey.deadline >= T(java.time.LocalDateTime).now()}">
													<span class="fa-solid fa-circle me-1 text-success" data-fa-transform="shrink-6 up-1"></span><span class="fw-bold fs-9 text-body lh-2">진행중</span>
												</div>
												<div class="d-flex align-items-center" th:if="${survey.deadline < T(java.time.LocalDateTime).now()}">
													<span class="fa-solid fa-circle me-1 text-danger" data-fa-transform="shrink-6 up-1"></span><span class="fw-bold fs-9 text-body lh-2">마감</span>
												</div>
											</div>
										</div>
										<p class="fs-9 fw-semibold text-body ms-1 text mb-4 ps-2" th:text="'작성자 : ' + ${survey.writer}">작성자</p>
									</div>
									<div class="row g-1 g-sm-3 mt-2 lh-1">
										<div class="col-12 col-sm-auto">
											<div class="d-flex align-items-center">
												<span class="me-2" data-feather="users" style="stroke-width: 2;"></span>
												<p class="mb-0 fs-9 fw-semibold text-body-tertiary reports">응답자 수</p>
											</div>
										</div>
										<div class="col-12 col-sm-auto">
											<div class="d-flex align-items-center">
												<span class="me-2" data-feather="clock" style="stroke-width: 2;"></span>
												<p class="mb-0 fs-9 fw-semibold text-body-tertiary date" th:text="'마감일시 : ' + ${#temporals.format(survey.deadline, 'yyyy.MM.dd HH:mm')}">마감일</p>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</th:block>
				</div>
				<div class="row align-items-center justify-content-between py-2 pe-0 fs-9 mt-2">
					<div class="col-4 d-flex">
						<button class="btn btn-subtle-primary me-1 mb-1" type="button" data-bs-toggle="modal" data-bs-target="#create-survey">
							<span class="fas fa-plus me-2"></span>설문 등록
						</button>
					</div>
					<div class="col-4 d-flex justify-content-center">
						<button class="page-link" data-list-pagination="prev">
							<span class="fas fa-chevron-left"></span>
						</button>
						<ul class="mb-0 pagination"></ul>
						<button class="page-link pe-0" data-list-pagination="next">
							<span class="fas fa-chevron-right"></span>
						</button>
					</div>
					<div class="col-4 d-flex justify-content-end">
						<p class="mb-0 d-none d-sm-block me-3 fw-semibold text-body" data-list-info="data-list-info"></p>
						<a class="fw-semibold" href="#!" data-list-view="*">더보기<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span></a><a class="fw-semibold d-none" href="#!" data-list-view="less">접기<span class="fas fa-angle-right ms-1" data-fa-transform="down-1"></span>
						</a>
					</div>
				</div>
			</div>
		</div>
	</main>
	<script>
		// 설문 등록시 항목 추가 스크립트
		document.addEventListener("DOMContentLoaded", function() {
			const addItemButton = document.getElementById('addItemBtn');
			const itemContainer = document.getElementById('itemContainer');

			addItemButton.addEventListener('click', function() {
				// wrapper div 생성
				const wrapper = document.createElement('div');
				wrapper.classList.add('d-flex', 'align-items-center', 'mb-2', 'item-wrapper');

				// input 생성
				const input = document.createElement('input');
				input.setAttribute('type', 'text');
				input.setAttribute('id', 'inputItem');
				input.setAttribute('name', 'items');
				input.classList.add('form-control', 'me-2');

				// 삭제 버튼 생성
				const removeBtn = document.createElement('button');
				removeBtn.setAttribute('type', 'button');
				removeBtn.classList.add('btn', 'btn-close', 'btn-sm');

				// 삭제 버튼 클릭 이벤트
				removeBtn.addEventListener('click', function() {
					wrapper.remove();
				});

				// 요소 조립
				wrapper.appendChild(input);
				wrapper.appendChild(removeBtn);
				itemContainer.appendChild(wrapper);

				// 설문 등록 항목 추가시 스크롤 맨 아래로 자동 이동
				const scrollTarget = itemContainer.parentElement;
				scrollTarget.scrollTop = scrollTarget.scrollHeight;
			});
		});
		
		// 설문 등록시 참여자 팀 선택 스크립트
		document.getElementById('selectTeam').addEventListener('change', function () {
		    const selectedTeamContainer = document.getElementById('selectedTeam');
		    const selected = Array.from(this.selectedOptions);
		
		    selected.forEach(option => {
		        const teamId = option.value;
		        const teamName = option.text;
		
		        if (!document.getElementById('selected-team-' + teamId)) {
		            const badge = document.createElement('span');
		            badge.className = 'badge badge-phoenix badge-phoenix-secondary me-2 mb-2';
		            badge.id = 'selected-team-' + teamId;
		            badge.innerHTML = `
		                ${teamName}
		                <button type="button" class="btn-close ms-1" style="font-size:0.6rem;" onclick="removeTeam('${teamId}')"></button>
		                <input type="hidden" name="selectedTeamIds" value="${teamId}">
		            `;
		            selectedTeamContainer.appendChild(badge);
		        }
		    });
		
		    // 선택된 항목 초기화 (선택 후 자동 해제)
		    this.selectedIndex = 0;
		});
		
		// 선택된 팀 삭제
		function removeTeam(teamId) {
		    const badge = document.getElementById('selected-team-' + teamId);
		    if (badge) badge.remove();
		}
		
		// 설문 등록시 유효성 검사
		document.addEventListener("DOMContentLoaded", function () {
		  const surveyForm = document.getElementById("surveyForm");
		
		  surveyForm.addEventListener("submit", function (event) {
		    const title = document.getElementById('surveyTitle').value.trim();
		    if (title === "") {
		      event.preventDefault();
		      alert("설문 제목을 입력해주세요.");
		      return;
		    }
		
		    const itemInputs = document.querySelectorAll('input[name="items"]');
		    const items = Array.from(itemInputs).map(input => input.value.trim()).filter(value => value !== "");
		
		    if (items.length < 2) {
		      event.preventDefault();
		      alert("설문 항목은 2개 이상 입력해주세요.");
		      return;
		    }
		
		    const deadlineInput = document.getElementById('basic-form-dob');
		    const deadlineValue = deadlineInput.value;
		    if (!deadlineValue) {
		      event.preventDefault();
		      alert("마감일을 선택해주세요.");
		      return;
		    }
		
		    const deadline = new Date(deadlineValue);
		    const now = new Date();
		    if (deadline <= now) {
		      event.preventDefault();
		      alert("마감일은 현재 시각보다 이후로 설정해야 합니다.");
		      return;
		    }
		  });
		});
		
		
		// 설문 상세 조회
document.addEventListener('DOMContentLoaded', function () {
  const surveyModal = document.getElementById('survey-detail');
  const itemList = document.getElementById('surveyItemList');
  const voteConfirmBtn = document.getElementById('voteConfirmBtn');
  let selectedItems = [];
  let currentSurveyId = null;
  let allowMultiple = false;

  document.querySelectorAll('button[data-survey-id]').forEach(button => {
    button.addEventListener('click', function () {
      const surveyId = this.getAttribute('data-survey-id');
      currentSurveyId = surveyId;
      selectedItems = [];
      itemList.innerHTML = '';

      fetch('/survey/detail?id=' + surveyId)
        .then(response => response.json())
        .then(data => {
          const items = data;  // 기존 항목 목록 받아오기
          allowMultiple = data.allowMultiple;  // 다중 선택 여부 확인

          if (!items || items.length === 0) {
            itemList.innerHTML = '<div class="text-muted">항목이 없습니다.</div>';
          } else {
            items.forEach(item => {
              const button = document.createElement('button');
              button.className = 'btn btn-outline-primary d-flex justify-content-between align-items-center';
              button.style.width = '100%';
              button.style.height = '3rem';
              button.setAttribute('data-item-id', item.itemNo);

              button.innerHTML = `
                <span>${item}</span>  <!-- 'item'으로 접근 -->
                <span class="badge bg-secondary">${item.percentage || 0}%</span>
              `;

              button.addEventListener('click', function () {
                const itemId = item.itemNo;
                const index = selectedItems.indexOf(itemId);

                if (index === -1) {
                  // 항목이 선택되지 않은 경우
                  if (!allowMultiple) {
                    selectedItems = [itemId];
                    document.querySelectorAll('#surveyItemList button').forEach(btn => {
                      btn.classList.remove('btn-primary');
                      btn.classList.add('btn-outline-primary');
                    });
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary');
                  } else {
                    selectedItems.push(itemId);
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary');
                  }
                } else {
                  // 항목이 이미 선택된 경우: 선택 해제
                  selectedItems.splice(index, 1);
                  this.classList.remove('btn-primary');
                  this.classList.add('btn-outline-primary');
                }
              });

              itemList.appendChild(button);
            });
          }
        })
        .catch(err => {
          console.error('항목 불러오기 실패:', err);
          itemList.innerHTML = '<div class="text-danger">불러오기 실패</div>';
        });
    });
  });

  voteConfirmBtn.addEventListener('click', function () {
    if (selectedItems.length === 0) {
      alert('투표할 항목을 선택해주세요.');
      return;
    }

    fetch('/survey/vote', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        surveyId: currentSurveyId,
        itemIds: selectedItems
      })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert('투표가 완료되었습니다.');
        bootstrap.Modal.getInstance(surveyModal).hide();
      } else {
        alert('투표에 실패했습니다: ' + data.message);
      }
    })
    .catch(err => {
      console.error('투표 오류:', err);
      alert('투표 처리 중 오류가 발생했습니다.');
    });
  });
});
	</script>
</th:block>
</html>