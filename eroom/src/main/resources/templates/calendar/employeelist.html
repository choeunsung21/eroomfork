<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{/include/layout}">

<head>
<title>개인 캘린더</title>
</head>
<body>

	<main class="main" id="top" layout:fragment="content">

		<div class="row g-0 mb-4 align-items-center">
			<div class="col-5 col-md-6">
				<h4 class="mb-0 text-body-emphasis fw-bold fs-md-6">
					<span class="calendar-day d-block d-md-inline mb-1"></span> <span
						class="px-3 fw-thin text-body-quaternary d-none d-md-inline">|</span>
					<span class="calendar-date"></span>
				</h4>
			</div>
			<div class="col-7 col-md-6 d-flex justify-content-end">
				<button class="btn btn-primary btn-sm" type="button"
					data-bs-toggle="modal" data-bs-target="#addEventModal">
					<span class="fas fa-plus pe-2 fs-10"></span>일정 등록
				</button>
			</div>
		</div>



<!-- 
	 	<div class="mx-n4 px-4 mx-lg-n6 px-lg-6 border-y border-translucent">
			<div class="row py-3 gy-3 gx-0">
				<div class="col-6 col-md-4 order-1 d-flex align-items-center">
					<button class="btn btn-sm btn-phoenix-primary px-4"
						data-event="today">Today</button>
				</div>
				<div
					class="col-12 col-md-4 order-md-1 d-flex align-items-center justify-content-center">
					<button
						class="btn icon-item icon-item-sm shadow-none text-body-emphasis p-0"
						type="button" data-event="prev" title="Previous">
						<span class="fas fa-chevron-left"></span>
					</button>
					<h3 class="px-3 text-body-emphasis fw-semibold calendar-title mb-0"></h3>
					<button
						class="btn icon-item icon-item-sm shadow-none text-body-emphasis p-0"
						type="button" data-event="next" title="Next">
						<span class="fas fa-chevron-right"></span>
					</button>
				</div>
				<div
					class="col-6 col-md-4 ms-auto order-1 d-flex justify-content-end">
					<div class="btn-group btn-group-sm" role="group">
						<button class="btn btn-phoenix-secondary active-view"
							data-fc-view="dayGridMonth">월별</button>
						<button class="btn btn-phoenix-secondary"
							data-fc-view="timeGridWeek">주별</button>
					</div>
				</div>
			</div>
		</div>  -->

		<!-- 일정 등록 모달 -->
		<div class="modal fade" id="addEventModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content border border-translucent">
					<form id="addEventForm" autocomplete="off" name="addEventForm">
						<div class="modal-header px-card border-0">
							<div
								class="w-100 d-flex justify-content-between align-items-start">
								<h5 class="mb-0 lh-sm text-body-highlight">일정 등록</h5>
								<button class="btn p-1 fs-10 text-body" type="button"
									data-bs-dismiss="modal" aria-label="Close">닫기</button>
							</div>
						</div>
						
						<div class="modal-body p-card py-0">
						
						 	<input type="hidden" name="employee_no"
								th:value="${#authentication.principal.employee.employeeNo}" /> 
								<input type="hidden" name="separator" value="E001" />
						 	<input type="hidden" name="calendar_creator"
								th:value="${#authentication.principal.employee.employeeId}" /> 
							<input type="hidden" name="calendar_no" value="">

							<div class="input-group input-group-sm mb-3">
								<span class="input-group-text" id="inputGroup-sizing-sm">제목</span>
								<input type="text" class="form-control" name="calendar_title"
									id="calendarTitle" placeholder="일정 제목" aria-label="일정 제목"
									aria-describedby="inputGroup-sizing-sm">
							</div>

							<!-- 장소 -->
							<div class="input-group input-group-sm mb-3">
								<span class="input-group-text" id="inputGroup-sizing-sm">장소</span>
								<input type="text" class="form-control" name="calendar_location"
									id="calendarLocation" placeholder="일정 장소" aria-label="일정 장소"
									aria-describedby="inputGroup-sizing-sm">
							</div>



							<div class="form-floating mb-3">
								<input class="form-control" id="calendarStartTime"
									type="datetime-local" name="calendar_start_time"
									placeholder="시작 시간" /> <label for="calendarStartTime">시작
									시간</label>
							</div>

							<div class="form-floating mb-3">
								<input class="form-control" id="calendarEndTime"
									type="datetime-local" name="calendar_end_time"
									placeholder="종료 시간" /> <label for="calendarEndTime">종료
									시간</label>
							</div>

							<div class="input-group input-group-lg mb-3">
								<span class="input-group-text" id="inputGroup-sizing-lg">설명</span>
								<input type="text" class="form-control" name="calendar_content"
									id="calendarContent" placeholder="일정 설명" aria-label="일정 설명"
									aria-describedby="inputGroup-sizing-lg">
							</div>

							<div
							class="modal-footer d-flex justify-content-between align-items-center border-0">
							<span></span>
							<button class="btn btn-primary px-4" type="submit">일정 등록</button>
						</div>
						</div>
					</form>
				</div>
			</div>
		</div>


		<!-- 캘린더 위치 -->
		<div class="calendar-outline mt-6 mb-9" id="appCalendar"></div>
		
		
		
		<!-- 일정 상세 조회 모달 -->
		
		<button class="btn btn-primary" type="button" data-bs-toggle="modal"
    	data-bs-target="#tooltipModal" style="display: none;" id="modalButton"></button>

		<!-- 모달 창 -->
		<div class="modal fade" id="tooltipModal" tabindex="-1"
			aria-labelledby="tooltipModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="tooltipModalLabel">내 일정 상세조회</h5>
						<button class="btn btn-close p-1" type="button"
							data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body" id = "detailModal">
						<strong>일정:</strong> <span id="eventTitle"></span>
						<p>
							<br> <strong>시간:</strong> <span id="eventDate"></span>
						</p>
						<p>
							<strong>장소:</strong> <span id="eventLocation"></span>
						</p>
						<p>
							<strong>설명:</strong> <span id="eventDescription"></span>
						</p>
						
					</div>
					
					<div class="modal-footer d-flex justify-content-between">
						<!-- 수정 및 삭제 버튼을 왼쪽 -->
						<div class="d-flex">
							<button class="btn btn-subtle-secondary me-1 mb-1" type="button" id="editEventBtn">수정</button>
							<button class="btn btn-outline-info me-1 mb-1" type="button">삭제</button>
						</div>
						<!-- 확인 버튼을 오른쪽에 배치 -->
						<div>
							<button class="btn btn-primary" type="button"
								data-bs-dismiss="modal">확인</button>
						</div>
					</div>
					
				</div>
			</div>
		</div>

	<script>
  	document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('appCalendar');
    const employeeNo = document.addEventForm.employee_no.value;
   


    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      locale: 'ko',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: ''
      },
      dayMaxEventRows: true,
      views: {
        dayGridMonth: {
          dayMaxEventRows: 3 // "more" 링크 생김
        }
      },
      dayCellContent: function (info) {
        return info.date.getDate();
      },
      dateClick: function (info) {
        // 날짜 클릭 시 모달 열고, 해당 날짜를 시작시간에 자동 설정
        const dateStr = info.dateStr + "T09:00";
        document.getElementById('calendarStartTime').value = dateStr;
        document.getElementById('calendarEndTime').value = info.dateStr + "T18:00";

        const addEventModal = new bootstrap.Modal(document.getElementById('addEventModal'));
        addEventModal.show();
      },

      eventClick: function (info) {
        document.getElementById('eventTitle').textContent = info.event.title;
        document.getElementById('eventDate').textContent = info.event.start.toISOString().slice(0, 16).replace("T", " ");
        document.getElementById('eventLocation').textContent = info.event.extendedProps.location || '';
        document.getElementById('eventDescription').textContent = info.event.extendedProps.description || '';
        
        selectedCalendarNo = info.event.extendedProps.calendar_no; // ✅ 이거 꼭 필요함!

        document.getElementById('modalButton').click();
      },
      eventDidMount: function (info) {
        const separator = info.event.extendedProps.separator || "";
        let backgroundColor, borderColor, textColor;

        switch (separator) {
          case "E001":
            backgroundColor = "#DFFBD9";
            borderColor = "#DFFBD9";
            textColor = "#000000";
            break;
        }

        info.el.style.setProperty("background-color", backgroundColor, "important");
        info.el.style.setProperty("border-color", borderColor, "important");
        info.el.style.setProperty("color", textColor, "important");

        const eventMain = info.el.querySelector('.fc-event-main');
        if (eventMain) {
          eventMain.style.setProperty("background-color", backgroundColor, "important");
          eventMain.style.setProperty("border-color", borderColor, "important");
          eventMain.style.setProperty("color", textColor, "important");
        }
      },
      events: function (fetchInfo, successCallback, failureCallback) {
        fetch('/employeecalendar/list/' + employeeNo)
          .then(response => response.json())
          .then(events => {
            successCallback(events);
          })
          .catch(error => {
            console.error("이벤트 불러오기 실패", error);
            failureCallback(error);
          });
      	}
    });

    	calendar.render();
		
  	});
  	
  	document.getElementById('editEventBtn').addEventListener('click', function () {
  	  // 1. 상세조회 모달 닫기
  	  const tooltipModal = bootstrap.Modal.getInstance(document.getElementById('tooltipModal'));
  	  tooltipModal.hide();

  	  // 2. 상세조회 내용 → 등록 모달 input으로 복사
  	  document.getElementById('calendarTitle').value = document.getElementById('eventTitle').textContent;
  	  document.getElementById('calendarLocation').value = document.getElementById('eventLocation').textContent;
  	  document.getElementById('calendarContent').value = document.getElementById('eventDescription').textContent;

  	  // ✅ 시간은 eventDate에 있는 "yyyy-MM-dd HH:mm" 문자열에서 처리
  	  const timeStr = document.getElementById('eventDate').textContent;
  	  const formatted = timeStr.replace(" ", "T"); // datetime-local 형식
  	  document.getElementById('calendarStartTime').value = formatted;
  	  document.getElementById('calendarEndTime').value = formatted;

  	  // ✅ calendarNo를 hidden input에 넣기
  	  document.querySelector('input[name="calendar_no"]').value = selectedCalendarNo;

  	  const addEventModal = new bootstrap.Modal(document.getElementById('addEventModal'));
  	  addEventModal.show();
  	});

  	document.getElementById('addEventForm').addEventListener('submit', function (e) {
  	  e.preventDefault();

  	  const form = e.target;
  	  const calendarNo = form.querySelector('input[name="calendar_no"]').value;

  	  const formData = new FormData(form);

  	  fetch('/calendar/update/' + calendarNo, {
  	    method: 'POST',
  	    headers: {
  	      'header': document.querySelector('meta[name="_csrf_header"]').content,
  	      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
  	    },
  	    body: formData
  	  })
  	  .then(response => response.json())
  	  .then(data => {
  	    alert(data.res_msg);
  	    if (data.res_code === 200) {
  	      location.href = '/calendar';
  	    }
  	  })
  	  .catch(error => {
  	    console.error('Error:', error);
  	  });
  	});
	</script>
	
	

		<!-- 일정 등록 처리 스크립트 -->
	<script>
    const form = document.addEventForm;
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      if (!form.calendar_location.value) {
        alert("장소를 입력해주세요");
        return;
      }

      const payload = new FormData(form);
      fetch("/employeecalendar/add", {
        method: "post",
        headers: {
          'header': document.querySelector('meta[name="_csrf_header"]').content,
          'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
        },
        body: payload
      })
        .then(response => response.json())
        .then(data => {
          alert(data.res_msg);
          if (data.res_code == 200) {
            location.reload();
          }
        });
    });
  </script>





	</main>
</body>