<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{/include/layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<script src="../../vendors/tinymce/tinymce.min.js"></script>

</head>
<body>
<main class="main" id="top" layout:fragment="content">
	<div class="col">
              <div class="card email-content">
                <div class="card-body">
                  <form class="d-flex flex-column h-100"
                  action="/mail/create" name="mail_create_form" enctype="multipart/form-data">
                  
                  <!-- 본인 히든 처리 -->
                  <input type="hidden" name="employee_no"
								th:value="${#authentication.principal.employee.employeeNo}" />
								
                    <div class="row g-3 mb-2">
                      <!-- <div class="col-4">
                        <input class="form-control" type="text" name="receiver" placeholder="받는 사람" />
                      </div> -->
                      
                      
                      
                      
                      <!-- test  -->
                   <div class="col-4">
                   		<input class="form-control" type="text" name="receiver" placeholder="받는 사람" id="receiverInput" readonly data-bs-toggle="modal" data-bs-target="#orgModal" />
                   </div>
                      <div class="modal fade" id="orgModal" tabindex="-1" aria-labelledby="orgModalLabel" aria-hidden="true">
						  <div class="modal-dialog modal-lg">
						    <div class="modal-content">
						      <div class="modal-header">
						        <h5 class="modal-title" id="orgModalLabel">조직도에서 직원 선택</h5>
						        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
						      </div>
						      <div class="modal-body">
						        <!-- Thymeleaf로 구성된 조직도 or 사원 리스트 -->
						        <div class="row">
						          <div class="col">
						            <ul>
						              <li th:each="emp : ${employeeList}">
						                <button type="button" class="btn btn-light mb-1 select-employee-btn"
						                  th:data-email="${emp.email}"
						                  th:data-name="${emp.name}"
						                  th:text="${emp.name + ' (' + emp.dept.name + ')'}">
						                </button>
						              </li>
						            </ul>
						          </div>
						        </div>
						      </div>
						    </div>
						  </div>
					</div>
                     <!-- test  -->  
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      
                      <!-- <div class="col-4">
                        <input class="form-control" type="email" name="cc" placeholder="참조" />
                      </div>
                      <div class="col-4">
                        <input class="form-control" type="email" placeholder="BCC" />
                      </div> -->
                      <div class="col-4">
                      	<input class="form-control" type="text" value="참조자 넣을곳">
                      </div>
                      <div class="col-12">
                        <input class="form-control" type="text" name="mail_title" placeholder="제목" />
                      </div>
                    </div>
                    <div class="mb-3 flex-1">
                      <textarea class="tinymce email-textarea" name="mail_content" data-tinymce='{"height":"100%"}'></textarea>
                    </div>
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="d-flex">
                        <label class="btn btn-link py-0 px-2 text-body fs-9" for="emailAttachment"> <span class="fa-solid fa-paperclip"></span></label>
                        <input class="d-none" id="emailAttachment" type="file" />
                        <label class="btn btn-link py-0 px-2 text-body fs-9" for="emailPhotos"><span class="fa-solid fa-image"></span></label>
                        <input class="d-none" id="emailPhotos" type="file" accept="image/*" />
                      </div>
                      <div class="d-flex">
                        <button class="btn btn-link text-body fs-10 text-decoration-none">Discard</button>
                        <button class="btn btn-primary fs-10" type="submit">Send<span class="fa-solid fa-paper-plane ms-1"></span></button>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <script>
            	const form = document.mail_create_form;
            	form.addEventListener('submit', (e)=>{
    				 e.preventDefault();
    				 tinymce.triggerSave();
    				const payload = new FormData(form);
            		console.log(form);
    				console.log(payload)
    				fetch("/mail/create",{
						method:'post',
						headers : {
							'header': document.querySelector('meta[name="_csrf_header"]').content,
				            'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content
						},
						body:payload
					})
					.then(response => response.json())
					.then(data=>{
						alert(data.res_msg);
						if(data.res_code==200){
							location.href='/mail/sent';
						}
					});
            	})
            </script>
            
</main>

</body>
</html>