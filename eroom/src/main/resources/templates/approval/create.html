<!DOCTYPE html>
<html lang="en-US" dir="ltr" data-navigation-type="default" data-navbar-horizontal-shape="default" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/include/layout}">
<head>
<style>
.custom-table td, .custom-table th {
	padding: 0.5rem !important;
	min-width: 75px;
}
</style>
<meta charset="UTF-8">
<title>결재서 작성</title>
</head>
<body>
	<main class="main" id="top" layout:fragment="content">
		<div class="col-8 mx-auto">
			<!-- <h2 class="mb-2 mx-auto">결재서 양식을 선택해주세요.</h2> -->
			<div class="d-flex justify-content-start">
				<span class="fw-bold fs-7" id="approvalPageTitle">결재서 양식을 선택해주세요.</span>
			</div>
			
			<form id="approvalWriter">
				<div class="row">
					<div class="col-5">
						<div class="mb-1">
							<label class="form-label" for="basic-form-date">신청일</label>
							<div id="basic-form-date" class="form-control" th:text="${now}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-department_name">부서</label>
							<div id="basic-form-department_name" class="form-control" th:text="${departmentName}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-team_name">팀명</label>
							<div id="basic-form-team_name" class="form-control" th:text="${employee.structure.codeName}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-employee_position">직급</label>
							<div id="basic-form-employee_position" class="form-control" th:text="${employee.employeePosition}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-employee_name">신청자</label>
							<div id="basic-form-employee_name" class="form-control" th:text="${employee.employeeName}"></div>
						</div>
					</div>
					<div class="col-7">


						<!-- 결재자 테이블 -->
						<table class="table table-bordered text-center align-middle ms-auto custom-table" style="width: 45%;">
							<thead class="table-light">
								<tr>
									<th>직급<br>결재자1
									</th>
									<th>직급<br>결재자2
									</th>
									<th>직급<br>결재자3
									</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td style="height: 80px;">(서명)</td>
									<td>(서명)</td>
									<td>(서명)</td>
								</tr>
							</tbody>
						</table>

						<!-- 합의자 테이블 -->
						<table class="table table-bordered text-center align-middle mt-3 ms-auto custom-table" style="width: 30%;">
							<thead class="table-light">
								<tr>
									<th>직급<br>합의자1
									</th>
									<th>직급<br>합의자2
									</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td style="height: 80px;">(서명)</td>
									<td>(서명)</td>
								</tr>
							</tbody>
						</table>

						<!-- 참조자 -->
						<div class="text-end text-body-secondary fs-8 mt-1">참조자 : 김대리, 이과장</div>
						
						<!-- 결재자 추가 공간 테스트 진행중 -->
						<div class="gap-2 mb-3 ms-right-2 d-flex justify-content-end">
							<span>결재자 : </span><div class="text-end text-body-secondary fs-8 mt-1" id="approveLine1"></div>
						</div>
						<div class="gap-2 mb-3 ms-right-2 d-flex justify-content-end">
							<span>합의자 : </span><div class="text-end text-body-secondary fs-8 mt-1" id="approveLine2"></div>
						</div>
						<div class="gap-2 mb-3 ms-right-2 d-flex justify-content-end">
							<span>참조자 : </span><div class="text-end text-body-secondary fs-8 mt-1" id="approveLine3"></div>
						</div>
						
						<!-- 추가 버튼 -->
						<div class="gap-2 mb-3 ms-right-2 d-flex justify-content-end" id="approveLineModalDiv">
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLine1Modal">결재자 선택</button>
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLine2Modal">합의자 선택</button>
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLine3Modal">참조자 선택</button>
						</div>

					</div>


				</div>


				<div class="mb-3">
					<label class="form-label" for="basic-form-title">제목</label> <input class="form-control" id="basic-form-title" type="text" placeholder="제목"> <label class="form-label" for="basic-select-format">양식 선택</label>
					<select class="form-select" id="basic-select-format" aria-label="Default select example">
						<option selected="selected" disabled="disabled">양식을 선택해주세요.</option>
						<option th:each="formList, formStatus : ${approvalFormatList}" th:value="${formList.approval_format_no}" th:text="${formList.approval_format_title}">경조금</option>
					</select>
				</div>

				<div class="mb-3">
					<label class="form-label" for="basic-form-textarea">결재 작성</label>
					<div class="form-control" id="basic-form-edit"></div>
				</div>

				<div class="mb-3">
					<label class="form-label">파일 업로드</label> <input class="form-control" type="file" multiple>
				</div>
				<button type="button" class="btn btn-light" onclick="history.back()">취소</button>
				<button id="approvalSubmitBtn" class="btn btn-primary" type="submit">등록</button>
			</form>
			
			
		</div>
		
		<!-- 결재자 생성 모달 -->
      <div class="modal fade" id="selectApproveLine1Modal" tabindex="-1"
        aria-labelledby="selectApproveLine1ModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h3>결재자 추가</h3>
              <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="닫기"></button>
            </div>
            <form id="createApprovalLineForm">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <div class="modal-body">
                <!-- 소속 선택 -->
                <div class="mb-3">
                  <label class="form-label">소속</label>
                  <select class="form-select" id="departmentSelect" onchange="changeDepartment(this.value)">
                    <option disabled selected>-- 소속 선택 --</option>
                    <option th:each="dept : ${structureList}" 
                      th:value="${dept.separator_code}" 
                      th:text="${dept.separator_name}" 
                      th:selected="${dept.separator_name == param.department}">
                    </option>
                  </select>
                </div>
                <!-- 참여자 선택 -->
                <div class="mb-3">
                  <label class="form-label">참여자 선택</label>
                  <div class="d-flex">
                    <select id="employeeSelect" class="form-select me-2" style="flex:1;">
                      <option disabled selected>-- 참여자 선택 --</option>
                    </select>
                    <button type="button" class="btn btn-outline-primary" onclick="addParticipant()">추가</button>
                  </div>
                </div>
                <!-- 선택된 참여자 표시 -->
                <div class="mb-3">
                  <label class="form-label">선택된 참여자</label>
                  <div id="selectedParticipants">
                    <!-- badge 형태로 추가 -->
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="submit" class="btn btn-primary">추가</button>
              </div>
              <div>
                <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- 합의자 생성 모달 -->
<div class="modal fade" id="selectApproveLine2Modal" tabindex="-1"
  aria-labelledby="selectApproveLine2ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h3>합의자 추가</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="닫기"></button>
      </div>
      <form id="createApprovalLineForm2">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">소속</label>
            <select class="form-select" id="departmentSelect2" onchange="changeDepartment(this.value)">
              <option disabled selected>-- 소속 선택 --</option>
              <option th:each="dept : ${structureList}" 
                th:value="${dept.separator_code}" 
                th:text="${dept.separator_name}" 
                th:selected="${dept.separator_name == param.department}"></option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">참여자 선택</label>
            <div class="d-flex">
              <select id="employeeSelect2" class="form-select me-2" style="flex:1;">
                <option disabled selected>-- 참여자 선택 --</option>
              </select>
              <button type="button" class="btn btn-outline-primary" onclick="addParticipant(2)">추가</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">선택된 참여자</label>
            <div id="selectedParticipants2"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">추가</button>
        </div>
        <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
      </form>
    </div>
  </div>
</div>
      
      
      
      <!-- 참조자 생성 모달 -->
<div class="modal fade" id="selectApproveLine3Modal" tabindex="-1"
  aria-labelledby="selectApproveLine3ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h3>참조자 추가</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="닫기"></button>
      </div>
      <form id="createApprovalLineForm3">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">소속</label>
            <select class="form-select" id="departmentSelect3" onchange="changeDepartment(this.value)">
              <option disabled selected>-- 소속 선택 --</option>
              <option th:each="dept : ${structureList}" 
                th:value="${dept.separator_code}" 
                th:text="${dept.separator_name}" 
                th:selected="${dept.separator_name == param.department}"></option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">참여자 선택</label>
            <div class="d-flex">
              <select id="employeeSelect3" class="form-select me-2" style="flex:1;">
                <option disabled selected>-- 참여자 선택 --</option>
              </select>
              <button type="button" class="btn btn-outline-primary" onclick="addParticipant(3)">추가</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">선택된 참여자</label>
            <div id="selectedParticipants3"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">추가</button>
        </div>
        <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
      </form>
    </div>
  </div>
</div>
      
      
		
		
		
		
		<!-- 결재서 양식 선택시, fetch로 결재서 양식 내용 가져오기 -->
		<script>
 	document.getElementById("basic-select-format").addEventListener("change", function () {
    const selectedValue = this.value;

    fetch("/approval/format", {
      method: 'POST',
      headers: {
	        'Content-Type': 'application/json',
	        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
	        'header': document.querySelector('meta[name="_csrf_header"]').content
	      },
	      body: JSON.stringify({ approval_format_no: selectedValue })
	    })
	    .then(response => response.json())
	    .then(data => {
	      if (data.res_code == "200") {
	        document.getElementById("basic-form-edit").innerHTML = data.approvalFormatContent;
	        document.getElementById("approvalPageTitle").innerText = data.approvalFormatTitle + ' 결재서 작성';
	      } else {
	        console.log(data.res_code);
	        console.log(data.res_msg);
      	}
    	});
  	});
	</script>
	
	<!-- 결재자 추가 스크립트 -->
	<script>
	
	let isCreateMode = true; // 기본은 생성 모드
	
	document.addEventListener("DOMContentLoaded", () => {
		  bindModalReset("#selectApproveLine1Modal");
		  bindModalReset("#selectApproveLine2Modal");
		  bindModalReset("#selectApproveLine3Modal");

		  bindDepartmentChange("#selectApproveLine1Modal");
		  bindDepartmentChange("#selectApproveLine2Modal");
		  bindDepartmentChange("#selectApproveLine3Modal");

		  bindParticipantAdd("#selectApproveLine1Modal");
		  bindParticipantAdd("#selectApproveLine2Modal");
		  bindParticipantAdd("#selectApproveLine3Modal");

		  bindApprovalModal("#selectApproveLine1Modal", "#approveLine1");
		  bindApprovalModal("#selectApproveLine2Modal", "#approveLine2");
		  bindApprovalModal("#selectApproveLine3Modal", "#approveLine3");
	});
	
	/* // 모달 초기화 (열릴 때 기본 리셋)
	function bindModalReset() {
	  const modal = document.getElementById("selectApproveLine1Modal");
	  if (!modal) return;
	
	  modal.addEventListener("shown.bs.modal", () => {
	    document.getElementById("selectedParticipants").innerHTML = "";
	    document.getElementById("departmentSelect").selectedIndex = 0;
	    const empSelect = document.getElementById("employeeSelect");
	    empSelect.innerHTML = '<option disabled selected>-- 참여자 선택 --</option>';
	
	
	    [...document.querySelectorAll('input[name="participantIds"]')].forEach(el => el.remove());
	  });
	} */
	// 모달 초기화 (열릴 때 기본 리셋)
	function bindModalReset(modalId) {
		  const modal = document.querySelector(modalId);
		  if (!modal) return;

		  modal.addEventListener("shown.bs.modal", () => {
		    modal.querySelector(".form-select").selectedIndex = 0;
		    modal.querySelector("select[id^='employeeSelect']").innerHTML = '<option disabled selected>-- 참여자 선택 --</option>';
		    modal.querySelector("#selectedParticipants").innerHTML = "";
		    modal.querySelectorAll('input[name="participantIds"]').forEach(el => el.remove());
		  });
		}

	
	/* // 소속 선택시 직원 목록 로딩
	function bindDepartmentChange() {
	  const departmentSelect = document.getElementById("departmentSelect");
	  if (!departmentSelect) return;
	
	  departmentSelect.addEventListener("change", function () {
	    const deptId = this.value;
	    fetch('/approval/employes?separator_code=' + encodeURIComponent(deptId))
	      .then(response => response.json())
	      .then(data => {
	        const select = document.getElementById('employeeSelect');
	        select.innerHTML = '<option disabled selected>-- 참여자 선택 --</option>';
	        data.forEach(emp => {
	          const option = document.createElement('option');
	          option.value = emp.employee_no;
	          option.text = emp.employee_name;
	          select.appendChild(option);
	        });
	      })
	      .catch(error => console.error('직원 로딩 실패:', error));
	  });
	} */
	// 소속 선택시 직원 목록 로딩
	function bindDepartmentChange(modalId) {
		  const modal = document.querySelector(modalId);
		  if (!modal) return;

		  const deptSelect = modal.querySelector("select[id^='departmentSelect']");
		  const empSelect = modal.querySelector("select[id^='employeeSelect']");
		  if (!deptSelect || !empSelect) return;

		  deptSelect.addEventListener("change", function () {
		    const deptId = this.value;
		    fetch('/approval/employes?separator_code=' + encodeURIComponent(deptId))
		      .then(response => response.json())
		      .then(data => {
		        empSelect.innerHTML = '<option disabled selected>-- 참여자 선택 --</option>';
		        data.forEach(emp => {
		          const option = document.createElement('option');
		          option.value = emp.employee_no;
		          option.text = emp.employee_name;
		          empSelect.appendChild(option);
		        });
		      })
		      .catch(error => console.error('직원 로딩 실패:', error));
		  });
		}

	
	
	
	/* // 참여자 추가
	function bindParticipantAdd() {
	  const btn = document.querySelector("button[onclick='addParticipant()']");
	  if (!btn) return;
	  btn.addEventListener("click", () => {
	    const select = document.getElementById('employeeSelect');
	    const selectedOptions = Array.from(select.selectedOptions);
	
	    if (selectedOptions.length === 0) {
	      alert('참여자를 선택해주세요.');
	      return;
	    }
	    const currentCount = document.querySelectorAll('#selectedParticipants .badge').length;
	
	    selectedOptions.forEach(option => {
	      const participantId = option.value;
	      const participantName = option.text;
	      if (document.getElementById('participant-' + participantId)) {
	        alert('이미 추가된 참여자입니다.');
	        return;
	      }
	      const badge = document.createElement('span');
	      badge.className = 'badge badge-phoenix badge-phoenix-secondary me-2 mb-2';
	      badge.id = 'participant-' + participantId;
	      badge.dataset.id = participantId;
	      badge.innerHTML = `
	        ${participantName}
	        <button type="button" class="btn-close ms-1" style="font-size:0.6rem;" onclick="this.parentElement.remove();"></button>
	      `;
	      document.getElementById('selectedParticipants').appendChild(badge);
	
	    });
	    select.selectedIndex = -1;
	  });
	} */
	// 참여자 추가
	function bindParticipantAdd(modalId) {
		  const modal = document.querySelector(modalId);
		  if (!modal) return;

		  const empSelect = modal.querySelector("select[id^='employeeSelect']");
		  const target = modal.querySelector("#selectedParticipants");
		  const btn = modal.querySelector("button[onclick^='addParticipant']");

		  if (!btn || !empSelect || !target) return;

		  btn.addEventListener("click", () => {
		    const selectedOptions = Array.from(empSelect.selectedOptions);
		    if (selectedOptions.length === 0) {
		      alert('참여자를 선택해주세요.');
		      return;
		    }

		    selectedOptions.forEach(option => {
		      const id = option.value;
		      const name = option.text;

		      if (document.getElementById('participant-' + id)) {
		        alert('이미 추가된 참여자입니다.');
		        return;
		      }

		      const badge = document.createElement('span');
		      badge.className = 'badge badge-phoenix badge-phoenix-secondary me-2 mb-2';
		      badge.id = 'participant-' + id;
		      badge.dataset.id = id;
		      badge.innerHTML = `
		        ${name}
		        <button type="button" class="btn-close ms-1" style="font-size:0.6rem;" onclick="this.parentElement.remove();"></button>
		      `;
		      target.appendChild(badge);
		    });

		    empSelect.selectedIndex = -1;
		  });
		}

	// 결재자 추가 시, 모달에서 선택된 참여자들 화면에 추가
	function bindApprovalModal(modalId, targetContainerId) {
		  const form = document.querySelector(`${modalId} form`);
		  const modalElement = document.querySelector(modalId);
		  const container = document.querySelector(targetContainerId);

		  if (!form || !modalElement || !container) return;

		  form.addEventListener("submit", function (e) {
		    e.preventDefault();

		    // 기존 숨은 input 제거
		    form.querySelectorAll('input[name="participantIds"]').forEach(el => el.remove());

		    // 기존 라인 초기화
		    container.innerHTML = "";

		    const selectedIds = [...document.querySelectorAll('#selectedParticipants span[data-id]')].map(span => span.dataset.id);

		    selectedIds.forEach(id => {
		      const nameText = document.getElementById("participant-" + id)?.textContent?.trim().replace("✕", "") || "이름없음";

		      const badge = document.createElement("span");
		      badge.className = 'badge bg-info text-dark me-2 mb-2';
		      badge.dataset.id = id;
		      badge.innerHTML = `
		        ${nameText}
		        <button type="button" class="btn-close btn-close-white ms-1" style="font-size:0.6rem;" aria-label="Remove"></button>
		      `;

		      // 삭제 시 container와 form 모두 반영
		      badge.querySelector("button").addEventListener("click", () => {
		        badge.remove();
		        const hidden = form.querySelector(`input[name="participantIds"][value="${id}"]`);
		        if (hidden) hidden.remove();
		      });

		      container.appendChild(badge);

		      const hidden = document.createElement("input");
		      hidden.type = "hidden";
		      hidden.name = "participantIds";
		      hidden.value = id;
		      form.appendChild(hidden);
		    });

		    const modal = bootstrap.Modal.getInstance(modalElement);
		    if (modal) modal.hide();
		  });
		}

	</script>


<!-- 결재 생성 submit -->
<script>
  document.getElementById('approvalSubmitBtn').addEventListener('click', function (event) {
    event.preventDefault(); // 기본 제출 방지

    // [1] 제목 & 양식 번호 추출
    const approvalTitle = document.getElementById("basic-form-title")?.value?.trim();
    const approvalFormatNo = document.getElementById("basic-select-format")?.value;

    // [2] 동적으로 삽입된 입력 필드 추출
    const inputElements = document.querySelectorAll("#basic-form-title, #basic-form-edit input, #basic-form-edit textarea, #basic-form-edit select");
    const approvalContent = {};
    let hasEmpty = false;

    inputElements.forEach(el => {
      const name = el.name || el.getAttribute("th:field")?.replace("*{", "").replace("}", "");
      const value = el.value?.trim();

      if (!value) {
        hasEmpty = true;
        el.style.border = "1px solid red"; // 시각적 경고
      } else {
        el.style.border = ""; // 초기화
        approvalContent[name] = value;
      }
    });

    // [3] 작성자 기본 정보 추출
    const writerFields = ["date", "department_name", "team_name", "employee_position", "employee_name"];
    const writerData = {};
    writerFields.forEach(field => {
      const el = document.getElementById(`basic-form-${field}`);
      writerData[field] = el ? (el.value ?? el.textContent.trim()) : null;
    });

    // [4] 유효성 검사
    if (!approvalTitle || !approvalFormatNo || hasEmpty) {
      alert("제목, 양식 및 모든 항목을 빠짐없이 입력해주세요.");
      return;
    }

    // [5] 서버로 전송
    fetch('/approval/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
        'header': document.querySelector('meta[name="_csrf_header"]').content
      },
      body: JSON.stringify({
        writer: writerData,
        title: approvalTitle,
        format_no: approvalFormatNo,
        content: approvalContent
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.res_code === "200") {
        alert("결재서가 성공적으로 제출되었습니다.");
        location.href = '/approval/myRequestedApprovals';
      } else {
        alert("결재서 제출에 실패했습니다. " + data.res_msg);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert("요청 중 오류가 발생했습니다.");
    });
  });
</script>




	</main>
</body>
</html>