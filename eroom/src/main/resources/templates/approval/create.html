<!DOCTYPE html>
<html lang="en-US" dir="ltr" data-navigation-type="default" data-navbar-horizontal-shape="default" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/include/layout}">
<head>
<style>
.custom-table td, .custom-table th {
	padding: 0.5rem !important;
	min-width: 75px;
}
</style>
<meta charset="UTF-8">
<title>결재서 작성</title>
</head>
<body>
	<main class="main" id="top" layout:fragment="content">
		<div class="col-8 mx-auto">
			<!-- <h2 class="mb-2 mx-auto">결재서 양식을 선택해주세요.</h2> -->
			<div class="d-flex justify-content-start">
				<span class="fw-bold fs-7" id="approvalPageTitle">결재서 양식을 선택해주세요.</span>
			</div>
			
			<form id="approvalWriter">
				<div class="row">
					<div class="col-5">
						<div class="mb-1">
							<label class="form-label" for="basic-form-date">신청일</label>
							<div id="basic-form-date" class="form-control" th:text="${now}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-department_name">부서</label>
							<div id="basic-form-department_name" class="form-control" th:text="${departmentName}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-team_name">팀명</label>
							<div id="basic-form-team_name" class="form-control" th:text="${employee.structure.codeName}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-employee_position">직급</label>
							<div id="basic-form-employee_position" class="form-control" th:text="${employee.employeePosition}"></div>
						</div>
						<div class="mb-1">
							<label class="form-label" for="basic-form-employee_name">신청자</label>
							<div id="basic-form-employee_name" class="form-control" th:text="${employee.employeeName}"></div>
						</div>
					</div>
					<div class="col-7">


						<!-- 결재자 테이블 -->
						<table class="table table-bordered text-center align-middle ms-auto custom-table" style="width: 45%;">
							<thead class="table-light">
								<tr>
									<th>직급<br>결재자1
									</th>
									<th>직급<br>결재자2
									</th>
									<th>직급<br>결재자3
									</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td style="height: 80px;">(서명)</td>
									<td>(서명)</td>
									<td>(서명)</td>
								</tr>
							</tbody>
						</table>

						<!-- 합의자 테이블 -->
						<table class="table table-bordered text-center align-middle mt-3 ms-auto custom-table" style="width: 30%;">
							<thead class="table-light">
								<tr>
									<th>직급<br>합의자1
									</th>
									<th>직급<br>합의자2
									</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td style="height: 80px;">(서명)</td>
									<td>(서명)</td>
								</tr>
							</tbody>
						</table>

						<!-- 참조자 -->
						<div class="text-end text-body-secondary fs-8 mt-1">참조자 : 김대리, 이과장</div>
						
						<!-- 결재자 추가 공간 테스트 진행중 -->
						<div class="gap-2 mb-3 ms-right-2 d-flex justify-content-end">
							<span>결재자 : </span><div class="text-end text-body-secondary fs-8 mt-1" id="approveLine1"></div>
						</div>
						<div class="gap-2 mb-3 ms-right-2 d-flex justify-content-end">
							<span>합의자 : </span><div class="text-end text-body-secondary fs-8 mt-1" id="approveLine2"></div>
						</div>
						<div class="gap-2 mb-3 ms-right-2 d-flex justify-content-end">
							<span>참조자 : </span><div class="text-end text-body-secondary fs-8 mt-1" id="approveLine3"></div>
						</div>
						
						<!-- 추가 버튼 -->
						<div class="gap-2 mb-3 ms-right-2 d-flex justify-content-end" id="approveLineModalDiv">
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLine1Modal">결재자 선택</button>
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLine2Modal">합의자 선택</button>
							<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#selectApproveLine3Modal">참조자 선택</button>
						</div>

					</div>


				</div>


				<div class="mb-3">
					<label class="form-label" for="basic-form-title">제목</label> <input class="form-control" id="basic-form-title" type="text" placeholder="제목"> <label class="form-label" for="basic-select-format">양식 선택</label>
					<select class="form-select" id="basic-select-format" aria-label="Default select example">
						<option selected="selected" disabled="disabled">양식을 선택해주세요.</option>
						<option th:each="formList, formStatus : ${approvalFormatList}" th:value="${formList.approval_format_no}" th:text="${formList.approval_format_title}">경조금</option>
					</select>
				</div>

				<div class="mb-3">
					<label class="form-label" for="basic-form-textarea">결재 작성</label>
					<div class="form-control" id="basic-form-edit"></div>
				</div>

				<div class="mb-3">
					<label class="form-label">파일 업로드</label> <input class="form-control" type="file" multiple>
				</div>
				<button type="button" class="btn btn-light" onclick="history.back()">취소</button>
				<button id="approvalSubmitBtn" class="btn btn-primary" type="submit">등록</button>
			</form>
			
			
		</div>
		
		<!-- 결재자 생성 모달 -->
      <div class="modal fade" id="selectApproveLine1Modal" tabindex="-1"
        aria-labelledby="selectApproveLine1ModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h3>결재자 추가</h3>
              <button type="button" class="btn-close" data-bs-dismiss="modal"
                aria-label="닫기"></button>
            </div>
            <form id="createApprovalLineForm1">
              <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
              <div class="modal-body">
                <!-- 소속 선택 -->
                <div class="mb-3">
                  <label class="form-label">소속</label>
                  <select class="form-select" id="approver-departmentSelect" onchange="changeDepartment(this.value)">
                    <option disabled selected>-- 소속 선택 --</option>
                    <option th:each="dept : ${structureList}" 
                      th:value="${dept.separator_code}" 
                      th:text="${dept.separator_name}" 
                      th:selected="${dept.separator_name == param.department}">
                    </option>
                  </select>
                </div>
                <!-- 참여자 선택 -->
                <div class="mb-3">
                  <label class="form-label">참여자 선택</label>
                  <div class="d-flex">
                    <select id="approver-employeeSelect" class="form-select me-2" style="flex:1;">
                      <option disabled selected>-- 참여자 선택 --</option>
                    </select>
                    <button type="button" class="btn btn-outline-primary" onclick="addParticipant()" data-action="addParticipant">추가</button>
                  </div>
                </div>
                <!-- 선택된 참여자 표시 -->
                <div class="mb-3">
                  <label class="form-label">선택된 참여자</label>
                  <div id="approver-selectedParticipants">
                    <!-- badge 형태로 추가 -->
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="submit" class="btn btn-primary">추가</button>
              </div>
              <div>
                <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
              </div>
            </form>
          </div>
        </div>
      </div>
      
      <!-- 합의자 생성 모달 -->
<div class="modal fade" id="selectApproveLine2Modal" tabindex="-1"
  aria-labelledby="selectApproveLine2ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h3>합의자 추가</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="닫기"></button>
      </div>
      <form id="createApprovalLineForm2">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">소속</label>
            <select class="form-select" id="agreer-departmentSelect" onchange="changeDepartment(this.value)">
              <option disabled selected>-- 소속 선택 --</option>
              <option th:each="dept : ${structureList}" 
                th:value="${dept.separator_code}" 
                th:text="${dept.separator_name}" 
                th:selected="${dept.separator_name == param.department}"></option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">참여자 선택</label>
            <div class="d-flex">
              <select id="agreer-employeeSelect" class="form-select me-2" style="flex:1;">
                <option disabled selected>-- 참여자 선택 --</option>
              </select>
              <button type="button" class="btn btn-outline-primary" onclick="addParticipant(2)" data-action="addParticipant">추가</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">선택된 참여자</label>
            <div id="agreer-selectedParticipants"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">추가</button>
        </div>
        <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
      </form>
    </div>
  </div>
</div>
      
      
      
      <!-- 참조자 생성 모달 -->
<div class="modal fade" id="selectApproveLine3Modal" tabindex="-1"
  aria-labelledby="selectApproveLine3ModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h3>참조자 추가</h3>
        <button type="button" class="btn-close" data-bs-dismiss="modal"
          aria-label="닫기"></button>
      </div>
      <form id="createApprovalLineForm3">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">소속</label>
            <select class="form-select" id="referer-departmentSelect" onchange="changeDepartment(this.value)">
              <option disabled selected>-- 소속 선택 --</option>
              <option th:each="dept : ${structureList}" 
                th:value="${dept.separator_code}" 
                th:text="${dept.separator_name}" 
                th:selected="${dept.separator_name == param.department}"></option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">참여자 선택</label>
            <div class="d-flex">
              <select id="referer-employeeSelect" class="form-select me-2" style="flex:1;">
                <option disabled selected>-- 참여자 선택 --</option>
              </select>
              <button type="button" class="btn btn-outline-primary" onclick="addParticipant(3)" data-action="addParticipant">추가</button>
            </div>
          </div>
          <div class="mb-3">
            <label class="form-label">선택된 참여자</label>
            <div id="referer-selectedParticipants"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">추가</button>
        </div>
        <input type="hidden" name="creater" th:value="${#authentication.principal.employee.employeeNo}">
      </form>
    </div>
  </div>
</div>
      
      
		
		
		
		
		<!-- 결재서 양식 선택시, fetch로 결재서 양식 내용 가져오기 -->
		<script>
 	document.getElementById("basic-select-format").addEventListener("change", function () {
    const selectedValue = this.value;

    fetch("/approval/format", {
      method: 'POST',
      headers: {
	        'Content-Type': 'application/json',
	        'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
	        'header': document.querySelector('meta[name="_csrf_header"]').content
	      },
	      body: JSON.stringify({ approval_format_no: selectedValue })
	    })
	    .then(response => response.json())
	    .then(data => {
	      if (data.res_code == "200") {
	        document.getElementById("basic-form-edit").innerHTML = data.approvalFormatContent;
	        document.getElementById("approvalPageTitle").innerText = data.approvalFormatTitle + ' 결재서 작성';
	      } else {
	        console.log(data.res_code);
	        console.log(data.res_msg);
      	}
    	});
  	});
	</script>
	
	<!-- 결재자 추가 스크립트 -->
	<script>
	
	let isCreateMode = true; // 기본은 생성 모드
	
	document.addEventListener("DOMContentLoaded", () => {
		  bindModalEvents("approver", "#selectApproveLine1Modal", "#approveLine1");
		  bindModalEvents("agreer", "#selectApproveLine2Modal", "#approveLine2");
		  bindModalEvents("referer", "#selectApproveLine3Modal", "#approveLine3");
	});
	
	function bindModalEvents(prefix, modalId, outputContainerId) {
		  const modal = document.querySelector(modalId);
		  const form = modal.querySelector("form");
		  const departmentSelect = modal.querySelector(`#${prefix}-departmentSelect`);
		  const employeeSelect = modal.querySelector(`#${prefix}-employeeSelect`);
		  const selectedContainer = modal.querySelector(`#${prefix}-selectedParticipants`);
		  const outputContainer = document.querySelector(outputContainerId);

		  // 모달 초기화
		  modal.addEventListener("shown.bs.modal", () => {
		    selectedContainer.innerHTML = "";
		    departmentSelect.selectedIndex = 0;
		    employeeSelect.innerHTML = '<option disabled selected>-- 참여자 선택 --</option>';
	    	// 기존 hidden input 제거
	    	document.querySelectorAll(`input[name="${prefix}Ids"]`).forEach(e => e.remove());
		    document.querySelectorAll(`input[name="${prefix}Steps"]`).forEach(e => e.remove());

		  });

		  // 부서 선택 시 직원 로드
		  departmentSelect.addEventListener("change", () => {
		    const deptId = departmentSelect.value;
		    fetch(`/approval/employes?separator_code=${encodeURIComponent(deptId)}`)
		      .then(res => res.json())
		      .then(data => {
		        employeeSelect.innerHTML = '<option disabled selected>-- 참여자 선택 --</option>';
		        data.forEach(emp => {
		          const opt = document.createElement("option");
		          opt.value = emp.employee_no;
		          opt.textContent = emp.employee_name;
		          employeeSelect.appendChild(opt);
		        });
		      });
		  });

		  // 참여자 추가
		  modal.querySelector("button[data-action='addParticipant']").addEventListener("click", () => {
		    const selectedOptions = Array.from(employeeSelect.selectedOptions);
		    selectedOptions.forEach(opt => {
		      const id = opt.value;
		      const name = opt.textContent;

		      if (selectedContainer.querySelector(`#${prefix}-participant-${id}`)) return;

		      const badge = document.createElement("span");
		      badge.className = "badge badge-phoenix badge-phoenix-secondary me-2 mb-2";
		      badge.id = `${prefix}-participant-${id}`;
		      badge.dataset.id = id;
		      badge.innerHTML = `${name} <button type="button" class="btn-close ms-1" style="font-size:0.6rem;" onclick="this.parentElement.remove();"></button>`;
		      selectedContainer.appendChild(badge);
		    });
		    employeeSelect.selectedIndex = -1;
		  });

		  // 모달 submit 시 출력에 뱃지 및 hidden input 추가
		  form.addEventListener("submit", e => {
		    e.preventDefault();
		    outputContainer.innerHTML = "";
		    form.querySelectorAll(`input[name="${prefix}Ids"]`).forEach(e => e.remove());

		    const selectedIds = [...selectedContainer.querySelectorAll('span[data-id]')].map(el => el.dataset.id);
		    selectedIds.forEach((id, index) => {
		      const name = selectedContainer.querySelector(`#${prefix}-participant-${id}`)?.textContent.replace("✕", "") || "이름없음";

		      const badge = document.createElement("span");
		      badge.className = 'badge bg-info text-dark me-2 mb-2';
		      badge.innerHTML = `${name} <button type="button" class="btn-close btn-close-white ms-1" aria-label="Remove"></button>`;
		      badge.querySelector("button").addEventListener("click", () => badge.remove());
		      outputContainer.appendChild(badge);

		      const hiddenId = document.createElement("input");
		      hiddenId.type = "hidden";
		      hiddenId.name = prefix + "Ids";
		      hiddenId.value = id;
		      badge.appendChild(hiddenId);
		      
		      const hiddenStep = document.createElement("input");
		      hiddenStep.type = "hidden";
		      hiddenStep.name = prefix + "Steps";
		      hiddenStep.value = index + 1;
		      badge.appendChild(hiddenStep);
		    });

		    bootstrap.Modal.getInstance(modal)?.hide();
		  });
		}

	</script>

	<script>
		document.getElementById('approvalSubmitBtn').addEventListener('click', function (event) {
		  event.preventDefault(); // 기본 제출 방지
		
		  // [1] 제목 & 양식 유효성 검사
		  const approvalTitle = document.getElementById("basic-form-title")?.value?.trim();
		  const formatSelect = document.getElementById("basic-select-format");
		  const approvalFormatNo = formatSelect?.value;
		  let isValid = true;
		
		  if (!approvalTitle) {
		    document.getElementById("basic-form-title").style.border = "1px solid red";
		    isValid = false;
		  } else {
		    document.getElementById("basic-form-title").style.border = "";
		  }
		
		  if (!approvalFormatNo || formatSelect.selectedIndex === 0) {
		    formatSelect.style.border = "1px solid red";
		    isValid = false;
		  } else {
		    formatSelect.style.border = "";
		  }
		
		  if (!isValid) {
		    alert("제목과 양식을 모두 입력해주세요.");
		    return;
		  }
		
		  // [2] 양식 입력 필드 유효성 검사 및 데이터 수집
		  const inputElements = document.querySelectorAll("#basic-form-edit [name]");
		  const approvalContent = {};
		  let hasEmpty = false;
		
		  inputElements.forEach(el => {
		    const name = el.name?.trim();
		    const value = el.value?.trim();
		
		    if (!name) return;
		
		    if (!value) {
		      hasEmpty = true;
		      el.classList.add("is-invalid");
		      el.style.border = "1px solid red";
		    } else {
		      el.classList.remove("is-invalid");
		      el.style.border = "";
		      approvalContent[name] = value;
		    }
		  });
		
		  if (hasEmpty) {
		    alert("결재서 내용을 모두 입력해주세요.");
		    return;
		  }
		
		  // [3] 결재선 유효성 검사
		  const approverIds = Array.from(document.querySelectorAll('input[name="approverIds"]')).map(el => el.value);
		  const approverSteps = Array.from(document.querySelectorAll('input[name="approverSteps"]')).map(el => parseInt(el.value));
		  const agreerIds = Array.from(document.querySelectorAll('input[name="agreerIds"]')).map(el => el.value);
		  const agreerSteps = Array.from(document.querySelectorAll('input[name="agreerSteps"]')).map(el => parseInt(el.value));
		  const refererIds = Array.from(document.querySelectorAll('input[name="refererIds"]')).map(el => el.value);
		  const refererSteps = Array.from(document.querySelectorAll('input[name="refererSteps"]')).map(el => parseInt(el.value));
		
		  if (approverSteps.length === 0 && agreerSteps.length === 0 && refererSteps.length === 0) {
		    alert("결재자, 합의자, 참조자를 한 명 이상 선택해주세요.");
		    return;
		  }
		
		  if (
		    approverIds.length !== approverSteps.length ||
		    agreerIds.length !== agreerSteps.length ||
		    refererIds.length !== refererSteps.length
		  ) {
		    alert("결재자 정보가 올바르지 않습니다. 다시 선택해주세요.");
		    return;
		  }
		
		  // [4] 작성자 정보 수집
		  const writerFields = ["date", "department_name", "team_name", "employee_position", "employee_name"];
		  const writerData = {};
		  writerFields.forEach(field => {
		    const el = document.getElementById(`basic-form-${field}`);
		    writerData[field] = el ? (el.value ?? el.textContent.trim()) : null;
		  });
		
		  // [5] 서버 전송
		  fetch('/approval/create', {
		    method: 'POST',
		    headers: {
		      'Content-Type': 'application/json',
		      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
		      'header': document.querySelector('meta[name="_csrf_header"]').content
		    },
		    body: JSON.stringify({
		      writer: writerData,
		      title: approvalTitle,
		      format_no: approvalFormatNo,
		      content: approvalContent,
		      approverIds,
		      approverSteps,
		      agreerIds,
		      agreerSteps,
		      refererIds,
		      refererSteps
		    })
		  })
		  .then(res => res.json())
		  .then(data => {
		    if (data.res_code === "200") {
		      alert("결재서가 성공적으로 제출되었습니다.");
		      location.href = '/approval/myRequestedApprovals';
		    } else {
		      alert("결재서 제출에 실패했습니다: " + data.res_msg);
		    }
		  })
		  .catch(err => {
		    console.error(err);
		    alert("요청 중 오류가 발생했습니다.");
		  });
		});
	</script>





	</main>
</body>
</html>