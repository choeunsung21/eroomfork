<!DOCTYPE html>
<html lang="en-US" dir="ltr" xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/include/layout}">
<head>
  <meta charset="UTF-8"/>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />
  <title>결재 상세</title>
</head>
<body class="bg-light">
  <main class="main" id="top" layout:fragment="content">
    <div class="container bg-white rounded shadow-sm p-4 mt-4" style="max-width: 1000px;">

      <!-- 상단 제목 + 목록 버튼 -->
      <div class="d-flex mb-3">
        <span class="fw-bold fs-6">결재서 상세</span>
        <button class="btn btn-light btn-sm ms-auto" id="topdf" type="button">pdf만들기</button>
        <button class="btn btn-light btn-sm ms-auto" onclick="history.back()">목록으로</button>
      </div>

      <!-- 기본 정보 + 결재선 테이블 병렬 정렬 -->
      <div class="d-flex flex-wrap gap-4">
        <!-- 기본 정보 -->
        <div class="flex-fill">
          <table class="table table-bordered text-dark">
            <tbody>
              <tr>
                <th class="table-light text-center" style="width: 150px;">신청일</th>
                <td th:text="${approval.reg_date}">신청일</td>
                <th class="table-light text-center">신청자</th>
                <td th:text="${approval.employee.employeeName}">신청자</td>
              </tr>
              <tr>
                <th class="table-light text-center">부서</th>
                <td th:text="${approval.employee.structure.codeName}">부서명</td>
                <th class="table-light text-center">직급</th>
                <td th:text="${approval.employee.employeePosition}">직급</td>
              </tr>
              <tr>
                <th class="table-light text-center">제목</th>
                <td colspan="3" th:text="${approval.approval_title}">제목</td>
              </tr>
              <tr>
                <th class="table-light text-center">양식 종류</th>
                <td colspan="3" th:text="${approval.approval_format.approvalFormatTitle}">양식 종류</td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- 결재선 -->
        <div style="min-width: 340px;">
          <table class="table table-bordered text-center align-middle mb-3">
            <thead class="table-light">
              <tr>
                <th th:each="line : ${approvalLineList}"
                 th:if="${line.approval_line_step >= 1}"
                  th:utext="|${line.employee.employeePosition}<br>${line.employee.employeeName}|"
                  >
                  직급<br>결재자1
                  </th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td th:if="${line.approval_line_step >= 1}" th:each="line : ${approvalLineList}">
                	<span th:if="${line.approval_line_status == 'A'}" th:text="서명넣기">서명</span>
                	<span th:if="${line.approval_line_status == 'S'}" th:text="대기중">대기</span>
                	<span th:if="${line.approval_line_status == 'D'}" th:text="반려">반려</span>
                </td>
              </tr>
            </tbody>
          </table>
          
          <table class="table table-bordered text-center align-middle">
            <thead class="table-light">
              <tr>
                <th th:each="line : ${approvalLineList}" th:if="${line.approval_line_step == 0}" 
                th:utext="|${line.employee.employeePosition}<br>${line.employee.employeeName}|">직급<br>합의자1</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td  th:if="${line.approval_line_step == 0}" th:each="line : ${approvalLineList}">
                	<span th:if="${line.approval_line_status == 'A'}" th:text="|합의|">서명!</span>
                	<span th:if="${line.approval_line_status == 'S'}" th:text="|대기중|">대기!</span>
                	<span th:if="${line.approval_line_status == 'D'}" th:text="|합의x|">반려!</span>
                </td>
              </tr>
            </tbody>
          </table>
          
		<!-- 참조자 텍스트 -->
		<div class="text-end text-body-secondary fs-8 mt-1" th:if="${line.approval_line_step == -1}" th:each="line : ${approvalLineList}">
			<span>참조자: </span>
			<span th:text="${line.employee.employeeName}">참조자!</span>
		</div>

        </div>
        
        
      </div>

      <!-- 결재 내용 -->
      <div class="bg-light rounded p-4 mt-4" th:replace="~{approval/templateFragment/congratulatory_payment :: congratulatory_payment}"></div>

      <!-- 첨부 파일 -->
      <div class="mt-4">
        <h6 class="mb-2">첨부 파일</h6>
        <ul class="ps-3">
          <li><a href="#" class="text-primary text-decoration-underline" onmouseover="this.style.textDecoration='none'" onmouseout="this.style.textDecoration='underline'">경조금_신청서.pdf</a></li>
          <li><a href="#" class="text-primary text-decoration-underline" onmouseover="this.style.textDecoration='none'" onmouseout="this.style.textDecoration='underline'">가족관계증명서.jpg</a></li>
        </ul>
      </div>

      <!-- 승인/반려 버튼 -->
      <div class="mt-4 text-end">
        <button type="button" class="btn btn-primary me-2">결재 승인</button>
        <button type="button" class="btn btn-outline-danger">반려</button>
      </div>
      <!-- 결재 삭제 버튼 -->
      <div class="mt-4 text-end" th:if="${approval.employee.employeeNo} == ${employee.employeeNo}">
        <button id="deleteBtn" type="button" class="btn btn-outline-danger">삭제</button>
        <button id="fallBackBtn" type="button" class="btn btn-outline-danger">회수</button>
      </div>
    </div>
    
    <!-- pdf 생성 버튼 -->
	<script>
	  document.getElementById("topdf").addEventListener("click", function() {
	    // meta 태그에서 CSRF 토큰과 헤더명 읽기
	    var csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
	    var csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");
	
	    // GET 요청일 경우, 쿼리 파라미터로 CSRF 토큰 전달 (예: headerName=token)
	    // CSRF 토큰이 필요 없다면 Spring Security 설정에서 GET은 제외할 수도 있습니다.
	    window.location.href = "/approval/detail/pdf?" 
	        + encodeURIComponent(csrfHeader) + "=" + encodeURIComponent(csrfToken);
	  });
	</script>
	<!-- 삭제 버튼 -->
	<script th:inline="javascript">
		document.getElementById("deleteBtn").addEventListener("click", function(){
			const deleteNo = [[${approval.approval_no}]];
			if(confirm('결재를 삭제하시겠습니까?')){
				fetch('/approval/' + deleteNo + '/delete',{
					method : 'POST',
					headers : {
				      'Content-Type': 'application/json',
				      'X-CSRF-Token': document.querySelector('meta[name="_csrf"]').content,
				      'header': document.querySelector('meta[name="_csrf_header"]').content
					}
				})
				.then(response => response.json())
				.then(data =>{
					alert(data.res_msg)
					if(data.res_code == 200){
						location.href='/approval/myRequestedApprovals';
					}
				})
			} else{
				
			}
		});
	
	</script>
    
  </main>
</body>
</html>
